در جلسه قبل، یک ویژگی بسیار جذاب برای پیدا کردن مقالات مرتبط ایجاد کردیم. اکنون می‌خواهیم این ویژگی را قوی‌تر و آماده استفاده در محیط واقعی (`production-ready`) کنیم.

---

### **۱. چالش اصلی: به‌روز نگه داشتن امبدینگ‌ها**

یک چالش مهم در کار با امبدینگ‌ها این است که اگر محتوای اصلی (مانند متن یک مقاله، توضیحات یک محصول یا تصویر آن) تغییر کند، بردار امبدینگ مرتبط با آن نیز باید **به‌روزرسانی شود**. در غیر این صورت، امبدینگ شما کهنه (`stale`) شده و دیگر نماینده دقیقی از محتوای فعلی نخواهد بود و در نتیجه، سیستم توصیه‌گر شما نتایج نادرستی را پیشنهاد خواهد داد.

---

### **۲. راه‌حل: ترکیب `Upsert` با فرآیندهای پس‌زمینه**

راه‌حل این مشکل، استفاده از الگوی **`Upsert`** است که قبلاً با آن آشنا شده‌ایم. فرآیند کلی به این صورت خواهد بود:

1.  **شناسایی تغییر:** هر زمان که محتوای یک مقاله یا محصول ذخیره می‌شود، سیستم باید بررسی کند که آیا محتوای اصلی تغییر کرده است یا خیر.
2.  **اجرای یک کار پس‌زمینه (`Background Job`):** اگر محتوا تغییر کرده باشد، یک کار پس‌زمینه (یا یک رویداد) فعال می‌شود.
3.  **تولید امبدینگ جدید:** این کار پس‌زمینه، محتوای جدید را به API مدل هوش مصنوعی ارسال کرده و بردار امبدینگ جدید را دریافت می‌کند.
4.  **استفاده از `Upsert` برای به‌روزرسانی پایگاه داده:** در نهایت، با استفاده از یک دستور `Upsert`، امبدینگ جدید را در پایگاه داده ذخیره می‌کنیم.

---

### **۳. پیاده‌سازی `Upsert` برای امبدینگ‌ها**

برای پیاده‌سازی `Upsert`، ما از ستون `slug` که دارای محدودیت `UNIQUE` است، به عنوان ستون تشخیص تداخل (`conflict`) استفاده می‌کنیم.

```postgresql
INSERT INTO articles (title, slug, embedding) VALUES (...)
ON CONFLICT (slug)
DO UPDATE SET embedding = excluded.embedding;
```

این دستور به صورت زیر عمل می‌کند:

*   اگر مقاله‌ای با `slug` داده شده در جدول وجود **نداشته باشد**، یک ردیف جدید با امبدینگ جدید درج می‌شود.
*   اگر مقاله‌ای با آن `slug` از قبل وجود **داشته باشد** (یعنی تداخل رخ دهد)، به جای درج، عملیات `UPDATE` انجام شده و فقط ستون `embedding` آن با مقدار جدیدی که قصد داشتیم درج کنیم (`excluded.embedding`)، به‌روزرسانی می‌شود.

---

### **۴. جمع‌بندی**

با ترکیب `Upsert` و فرآیندهای پس‌زمینه، می‌توانیم یک سیستم کاملاً خودکار برای **به‌روز نگه داشتن (`fresh`)** بردارهای امبدینگ خود ایجاد کنیم. این کار تضمین می‌کند که ویژگی‌های مبتنی بر شباهت (مانند مقالات مرتبط یا محصولات پیشنهادی) همیشه بر اساس آخرین نسخه از محتوا عمل کرده و نتایج دقیق و مرتبطی را ارائه دهند. این یک نمونه عالی دیگر از ترکیب مفاهیم مختلفی است که در طول دوره یاد گرفته‌ایم تا یک راه‌حل قوی و کامل بسازیم.