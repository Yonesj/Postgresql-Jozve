برای بهبود عملکرد جستجو روی بردارهای امبدینگ، باید از ایندکس‌های مخصوصی استفاده کنیم. در `pgvector`، دو نوع ایندکس اصلی برای این کار وجود دارد: `IVFFlat` و `HNSW`.

---

### **۱. یک تفاوت بنیادین با ایندکس‌های سنتی**

ایندکس‌های برداری یک قانون اصلی ایندکس‌گذاری را نقض می‌کنند: **ایندکس نباید نتایج کوئری را تغییر دهد**.

*   **جستجوی بدون ایندکس:** زمانی که شما یک جستجوی برداری را بدون ایندکس اجرا می‌کنید، `pgvector` یک **جستجوی دقیق نزدیک‌ترین همسایه (Exact Nearest Neighbor Search)** انجام می‌دهد و نتایج کاملاً دقیق هستند.
*   **جستجوی با ایندکس:** اما زمانی که از یک ایندکس برداری استفاده می‌کنید، جستجو به یک **جستجوی تقریبی نزدیک‌ترین همسایه (Approximate Nearest Neighbor Search)** تبدیل می‌شود. این یعنی نتایج ممکن است با نتایج جستجوی بدون ایندکس کمی متفاوت باشند.

این یک بده‌بستان (trade-off) بین **سرعت و دقت** است که برای دستیابی به عملکرد بالا در مجموعه داده‌های بزرگ، کاملاً قابل قبول و ضروری است. شما می‌توانید با تنظیم پارامترهای مختلف، این تعادل را کنترل کنید.

---

### **۲. نوع اول: ایندکس `IVFFlat` (Inverted File Flat)**

این نوع ایندکس، یک انتخاب **عمومی و خوب** برای شروع است. **نحوه ایجاد:**

```postgresql
CREATE INDEX articles_embedding_ivfflat_idx 
ON articles 
USING ivfflat (embedding vector_l2_ops)
WITH (lists = 10);
```

**نکات مهم:**

*   `USING ivfflat`: نوع ایندکس را مشخص می‌کند.
*   `vector_l2_ops`: این بخش بسیار مهم است. شما باید **کلاس اپراتور (operator class)** متناظر با اپراتور فاصله‌ای را که قصد استفاده از آن را دارید، مشخص کنید. این کار به PostgreSQL می‌گوید که چه زمانی از این ایندکس استفاده کند. (گزینه‌های دیگر: `vector_ip_ops` برای ضرب داخلی و `vector_cosine_ops` برای شباهت کسینوسی).
*   `WITH (lists = ...)`: شما می‌توانید با این پارامتر، تعداد لیست‌هایی را که ایندکس برای دسته‌بندی بردارها استفاده می‌کند، تنظیم کنید. یک فرمول پیشنهادی برای این عدد وجود دارد که به تعداد ردیف‌ها بستگی دارد.
*   **عیب:** برای بهترین عملکرد، بهتر است ایندکس `IVFFlat` روی جدولی ایجاد شود که از قبل حاوی داده است.

---

### **۳. نوع دوم: ایندکس `HNSW` (Hierarchical Navigable Small World)**

این نوع ایندکس، یک گزینه پیشرفته‌تر است که می‌تواند عملکرد و دقت بالاتری را ارائه دهد. **نحوه ایجاد:**

```postgresql
CREATE INDEX articles_embedding_hnsw_idx
ON articles 
USING hnsw (embedding vector_l2_ops);
```

**مقایسه با `IVFFlat`:**

*   **مزایا:** `HNSW` معمولاً **عملکرد بهتر و دقت بالاتری** (recall بهتر) نسبت به `IVFFlat` دارد.
*   **معایب:** `HNSW` برای نگهداری **پرهزینه‌تر** است و به منابع بیشتری (هم حافظه و هم پردازنده) نیاز دارد.

---

### **۴. انتخاب بین `IVFFlat` و `HNSW`**

*   **`IVFFlat`:** یک ایندکس عمومی و عالی برای شروع و برای اکثر کاربردهاست.
*   **`HNSW`:** اگر به دنبال بالاترین عملکرد و دقت ممکن هستید و مایل به تخصیص منابع بیشتر هستید، `HNSW` انتخاب بهتری است.

---

### **۵. نکته‌ای در مورد وضعیت در حال تحول `pgvector`**

باید به خاطر داشت که `pgvector` و به طور کلی دنیای امبدینگ‌ها به سرعت در حال تغییر و تحول است. در زمان ضبط این دوره، `pgvector` هنوز به نسخه `1.0` نرسیده است. بنابراین، به جای ارائه قوانین سخت و قطعی، هدف این بخش ارائه اصول کلی و موارد استفاده رایج بود. با این دانش، شما اکنون قادر هستید که کار با `pgvector` را شروع کرده و راه‌حل‌های خود را بسازید.