### **جلسه ۲۸: ذخیره‌سازی داده‌های JSON**

ما به یک موضوع نسبتاً بحث‌برانگیز نزدیک می‌شویم و آن، قرار دادن داده‌های بدون ساختار یا به طور کلی JSON در یک پایگاه داده رابطه‌ای است. برخی افراد متعصب معتقدند که هرگز نباید این کار را انجام داد، در حالی که برخی دیگر از این ایده استقبال کرده و PostgreSQL را مانند یک دیتابیس NoSQL (مانند MongoDB) با یک ستون JSON بزرگ می‌بینند. رویکرد ما در این دوره، اتخاذ یک دیدگاه میانی و متعادل است.

---

#### **۱. راهنمای تصمیم‌گیری: چه زمانی از JSON استفاده کنیم؟**

ذخیره داده به صورت JSON در PostgreSQL، به خصوص با توجه به قابلیت‌های گسترده آن، قابل تأمل است. اما قبل از این کار، باید به چند سوال کلیدی پاسخ دهید تا بهترین روش را برای مدل‌سازی داده‌های خود انتخاب کنید.

- **الگوهای دسترسی و کوئری:** اگر نیاز دارید که به طور مداوم بر اساس یک کلید خاص در داخل JSON کوئری بزنید (مثلاً جستجوی کاربر بر اساس ایمیل ذخیره شده در JSON)، این یک نشانه قوی است که شاید بهتر باشد آن کلید به یک ستون مجزا در سطح بالای جدول منتقل شود. با این حال، این یک قانون قطعی نیست، زیرا PostgreSQL ابزارهای قدرتمندی برای کوئری و حتی ایندکس‌گذاری روی کلیدهای داخل JSON دارد.

- **الگوهای به‌روزرسانی و اسکیما:** اگر ساختار داده‌های شما کاملاً مشخص، ثابت و به خوبی تعریف شده است، و بخش‌های مختلف آن به صورت مستقل به‌روزرسانی می‌شوند، احتمالاً بهتر است آن‌ها را به ستون‌های مجزا تقسیم کنید. در مقابل، اگر کل سند JSON همیشه به صورت یکجا و به طور کامل به‌روزرسانی می‌شود، نگه داشتن آن به صورت یک ستون JSON منطقی‌تر است.

- **اندازه سند JSON:** یک ستون از نوع `JSONB` می‌تواند تا ۲۵۵ مگابایت داده را در خود جای دهد. اما اینکه "می‌توانید" این کار را انجام دهید، به این معنا نیست که "باید" این کار را بکنید. اگر با اسناد JSON بسیار بزرگ سروکار دارید، عملکرد سیستم شما تحت تأثیر قرار خواهد گرفت. در چنین مواردی، بهتر است سند بزرگ را به چند سند کوچکتر و مجزا تقسیم کنید.

---

#### **۲. تفاوت کلیدی: `JSON` در مقابل `JSONB`**

در PostgreSQL دو نوع داده مختلف برای ذخیره JSON وجود دارد: `JSON` و `JSONB`. دانستن تفاوت این دو بسیار حیاتی است.

- **نوع داده `JSON`:** این نوع داده، سند JSON را به صورت **متن خام (raw text)** ذخیره می‌کند.
- **نوع داده `JSONB`:** این نوع داده، سند JSON را پس از تجزیه (parse) کردن، به صورت یک **فرمت باینری (binary)** بهینه شده ذخیره می‌کند.

---

#### **۳. بررسی عملی `JSON` (ذخیره‌سازی متنی)**

نوع داده `JSON` هر چیزی را که به آن بدهید، به شرطی که یک JSON معتبر باشد، دقیقاً همان‌طور که هست، حفظ می‌کند. این شامل موارد زیر است:

- **فضاهای خالی (Whitespace):** تمام فاصله‌ها و خطوط جدید حفظ می‌شوند.
- **کلیدهای تکراری (Duplicate Keys):** اگر یک سند JSON با کلیدهای تکراری به آن بدهید، همه آن‌ها را نگه می‌دارد.
- **ترتیب کلیدها (Key Order):** ترتیب کلیدها دقیقاً همان‌طور که وارد شده، حفظ می‌شود.

```postgresql
SELECT '{"c": 3, "a": 2, "a": "hello", "b":      "world"}' :: JSON;
-- {"c": 3, "a": 2, "a": "hello", "b":      "world"}
```

---

#### **۴. بررسی عملی `JSONB` (ذخیره‌سازی باینری)**

در مقابل، `JSONB` رفتار متفاوتی دارد، زیرا متن را ذخیره نمی‌کند، بلکه ساختار تجزیه شده آن را ذخیره می‌کند.

- **فضاهای خالی (Whitespace):** تمام فضاهای خالی غیرضروری حذف می‌شوند.
- **کلیدهای تکراری (Duplicate Keys):** کلیدهای تکراری حذف شده و فقط آخرین مقدار نگه داشته می‌شود.
- **ترتیب کلیدها (Key Order):** ترتیب کلیدها ممکن است تغییر کند، زیرا در استاندارد JSON، ترتیب کلیدها اهمیتی ندارد.

```postgresql
SELECT '{"c": 3, "a": 2, "a": "hello", "b":      "world"}' :: JSONB;
-- {"a": "hello", "b": "world", "c": 3}
```

---

#### **۵. توصیه نهایی: کدام را انتخاب کنیم؟**

**تقریباً همیشه باید از `JSONB` استفاده کنید.** این نوع داده برای کارایی بهینه شده است و اکثر قابلیت‌های پیشرفته JSON در PostgreSQL روی آن کار می‌کنند. است. اگرچه `JSONB` ممکن است به دلیل اطلاعات باینری اضافی، فضای بیشتری روی دیسک اشغال کند، اما چون داده‌ها از قبل تجزیه شده‌اند، عملیات کوئری زدن، فیلتر کردن و به‌روزرسانی روی آن به مراتب **سریع‌تر** از نوع `JSON` است.

تنها زمانی از نوع `JSON` استفاده کنید که به دلایل خاص (معمولاً در کدهای legacy)، نیاز به حفظ دقیق فرمت ورودی (شامل فضاهای خالی، کلیدهای تکراری یا ترتیب کلیدها) داشته باشید. در غیر این صورت، `JSONB` انتخاب صحیح است.

---

#### **۶. مقدمه‌ای بر اپراتورهای کار با JSON**

در جلسات آینده به طور کامل به این موضوع خواهیم پرداخت، اما به عنوان یک مقدمه، PostgreSQL اپراتورهای قدرتمندی برای استخراج داده از JSON دارد.

- **اپراتور `->`:** این اپراتور یک کلید را از یک شیء JSON استخراج می‌کند و نتیجه را به صورت یک مقدار **JSON** برمی‌گرداند. (مثلاً خروجی یک رشته، به صورت `"hello world"` خواهد بود).
- **اپراتور `->>`:** این اپراتور یک کلید را استخراج کرده و نتیجه را به صورت **`text`** برمی‌گرداند. (مثلاً خروجی همان رشته، به صورت `hello world` و بدون کوتیشن خواهد بود).

شما می‌توانید این اپراتورها را برای دسترسی به کلیدهای تودرتو یا اندیس‌های آرایه نیز زنجیروار به کار ببرید.
