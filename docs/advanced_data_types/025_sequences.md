### **جلسه 25: کار با دنباله‌ها (Sequences)**

در این جلسه، به صورت اختصاصی با دنباله‌ها (Sequences) کار کرده و یاد می‌گیریم چگونه یک دنباله مستقل که به یک ستون `SERIAL` وابسته نیست، ایجاد و مدیریت کنیم.

---

#### **۱. نحوه ایجاد یک دنباله مستقل**

ایجاد یک دنباله بسیار ساده است و با دستور `CREATE SEQUENCE` انجام می‌شود. هنگام ایجاد، شما می‌توانید گزینه‌های مختلفی را برای سفارشی‌سازی رفتار آن مشخص کنید.

- **نوع داده (`AS`):** می‌توانید نوع داده عددی دنباله را مشخص کنید (مثلاً `bigint`).
- **مقدار افزایش (`INCREMENT BY`):** به صورت پیش‌فرض، دنباله در هر بار فراخوانی یک واحد افزایش می‌یابد، اما شما می‌توانید این مقدار را به هر عدد دیگری تغییر دهید.
- **مقدار شروع (`START WITH`):** می‌توانید مشخص کنید که دنباله از چه عددی شروع شود. این ویژگی زمانی بسیار مفید است که در حال انتقال داده از یک سیستم دیگر هستید و می‌خواهید دنباله از آخرین شناسه موجود در آن سیستم ادامه یابد.
- **حداقل و حداکثر مقدار (`MINVALUE` / `MAXVALUE`):** می‌توانید یک محدوده حداقل و حداکثر برای مقادیر تولیدی توسط دنباله تعیین کنید.
- **مقدار کَش (`CACHE`):** این گزینه به PostgreSQL می‌گوید که چه تعداد از مقادیر دنباله را در حافظه خود پیش‌بارگذاری (cache) کند تا فراخوانی‌های بعدی سریع‌تر انجام شود. مقدار پیش‌فرض آن ۱ است و معمولاً نیازی به تغییر آن نیست.

```postgresql
CREATE SEQUENCE seq_name
	AS BIGINT
	INCREMENT 1
	START 1
	MINVALUE 1
	MAXVALUE 8468464846846466;
```

---

#### **۲. توابع اصلی برای کار با دنباله‌ها**

سه تابع اصلی برای تعامل با یک دنباله وجود دارد که رفتار هر کدام را باید به دقت بشناسیم.

- **`nextval('sequence_name')`:** این تابع اصلی‌ترین تابع است. با هر بار فراخوانی، **مقدار بعدی** را از دنباله برمی‌گرداند و شمارنده داخلی دنباله را یک واحد به جلو می‌برد. این تابع همان چیزی است که باعث تولید مقادیر متوالی و منحصر به فرد می‌شود.

- **`currval('sequence_name')`:** این تابع **آخرین مقداری که توسط `nextval` در همین نشست (session) فراخوانی شده** را برمی‌گرداند. این نکته بسیار مهمی است. `currval` مقدار فعلی سراسری (global) دنباله را نشان نمی‌دهد، بلکه فقط به نشست شما وابسته است. این ویژگی به شما اجازه می‌دهد که در طول یک تراکنش، بدون نیاز به ذخیره کردن مقدار در یک متغیر، بارها به آخرین شناسه‌ای که دریافت کرده‌اید دسترسی داشته باشید. اگر در یک نشست، هنوز `nextval` را فراخوانی نکرده باشید، اجرای `currval` با خطا مواجه خواهد شد.

- **`setval('sequence_name', value)`:** این تابع به شما اجازه می‌دهد تا مقدار فعلی یک دنباله را به صورت دستی **تنظیم مجدد (reset)** کنید. در استفاده از این تابع باید بسیار مراقب باشید. تنظیم مجدد یک دنباله به یک عدد پایین‌تر می‌تواند باعث ایجاد مقادیر تکراری و بروز خطا در کلیدهای اصلی شود. با این حال، تنظیم آن به یک عدد بالاتر می‌تواند برای رد شدن از یک محدوده از شناسه‌ها مفید باشد.

```postgresql
SELECT nextval('seq_name');    -- 1
SELECT nextval('seq_name');    -- 2
SELECT currval('seq_name');    -- 2

SELECT setval('seq_name', 75); -- 75
SELECT nextval('seq_name');    -- 76
```

---

#### **۳. درک رفتار `currval` در نشست‌های مختلف**

برای درک بهتر رفتار `currval`، تصور کنید دو نشست همزمان در حال کار با یک دنباله هستند. اگر نشست اول `nextval` را فراخوانی کرده و مقدار `28` را دریافت کند، `currval` در همان نشست همیشه `28` را برمی‌گرداند. حال اگر نشست دوم چندین بار `nextval` را فراخوانی کرده و دنباله را به مقدار `44` برساند، اجرای مجدد `currval` در **نشست اول** همچنان `28` را برمی‌گرداند، زیرا به آخرین فراخوانی `nextval` در نشست خودش وفادار است، نه به وضعیت کلی دنباله.

<img src="../../assets/images/advanced_data_types/currval_behavior.png" />

---

#### **۴. جمع‌بندی**

دنباله‌ها ابزارهای بسیار قدرتمندی در PostgreSQL هستند که نه تنها در پس‌زمینه `SERIAL` کار می‌کنند، بلکه می‌توانند به صورت مستقل نیز برای تولید انواع شناسه‌های منحصر به فرد و متوالی مورد استفاده قرار گیرند. آشنایی با توابع `nextval`، `currval` و `setval` و درک دقیق رفتار آن‌ها، به خصوص در محیط‌های همزمان، برای استفاده صحیح از این قابلیت ضروری است.
