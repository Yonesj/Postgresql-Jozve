### **جلسه ۳۸: محدودیت کلید خارجی (Foreign Key Constraint)**

در این جلسه به بررسی محدودیت کلید خارجی می‌پردازیم، اما قبل از آن باید یک تمایز بسیار مهم را درک کنیم.

---

#### **۱. تفاوت کلید خارجی با محدودیت کلید خارجی**

این دو مفهوم اغلب به جای یکدیگر به کار می‌روند، اما با هم متفاوت هستند.

- **کلید خارجی (Foreign Key):** این یک **مفهوم** است. یک کلید خارجی صرفاً یک ستون (یا مجموعه‌ای از ستون‌ها) در یک جدول "فرزند" (child table) است که به یک شناسه در یک جدول "والد" (parent table) اشاره می‌کند. این مفهوم به خودی خود هیچ محدودیتی را اعمال نمی‌کند و صرفاً یک اشاره‌گر است.

- **محدودیت کلید خارجی (Foreign Key Constraint):** این یک **قانون واقعی** است. این محدودیت، **یکپارچگی ارجاعی (referential integrity)** را تضمین می‌کند. یعنی به پایگاه داده می‌گوید که مقداری که در ستون کلید خارجی جدول فرزند قرار می‌گیرد، **باید** حتماً در جدول والد وجود داشته باشد. اگر وجود نداشت، پایگاه داده باید جلوی عملیات را بگیرد.

در این جلسه، ما بر روی **محدودیت کلید خارجی** تمرکز خواهیم کرد.

---

#### **۲. نحوه ایجاد یک محدودیت کلید خارجی ساده**

برای ایجاد این محدودیت، پس از تعریف ستون کلید خارجی، از کلمه کلیدی `REFERENCES` به همراه نام جدول و ستون والد استفاده می‌کنیم.

```postgresql
CREATE TABLE states (
	id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	name TEXT NOT NULL
);

CREATE TABLE cities (
	id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	state_id BIGINT REFERENCES states(id),
	name TEXT NOT NULL
);
```

**نکات مهم در تعریف:**

- **تطابق نوع داده:** نوع داده ستون کلید خارجی در جدول فرزند باید دقیقاً با نوع داده ستون کلید در جدول والد **مطابقت** داشته باشد.
- **منحصر به فرد بودن ستون والد:** ستونی که در جدول والد به آن ارجاع داده می‌شود، باید حتماً دارای یک محدودیت **`UNIQUE`** یا **`PRIMARY KEY`** باشد. این کار تضمین می‌کند که هر ارجاع، به یک و تنها یک ردیف در جدول والد اشاره دارد.

با ایجاد این محدودیت، اگر تلاش کنید ردیفی را در جدول فرزند (`cities`) با یک `state_id` که در جدول والد (`states`) وجود ندارد، درج کنید، PostgreSQL با یک خطای واضح جلوی شما را می‌گیرد.

```postgresql
INSERT INTO states (name) VALUES ('Texas') RETURNING id; -- 1
INSERT INTO cities (state_id, name) VALUES (1, 'Dallas'); -- inserted
INSERT INTO cities (state_id, name) VALUES (12, 'Dallas');
-- ERROR:  insert or update on table "cities" violates foreign key constraint "cities_state_id_fkey"
-- DETAIL:  Key (state_id)=(12) is not present in table "states".
```

---

#### **۳. کلید خارجی ترکیبی (Composite Foreign Key)**

شما می‌توانید یک محدودیت کلید خارجی را روی ترکیبی از چند ستون نیز اعمال کنید. برای این کار، باید محدودیت را به صورت یک **محدودیت جدول (table constraint)** در انتهای تعریف جدول فرزند قرار دهید.

```postgresql
FOREIGN KEY (col_a, col_b) REFERENCES parent_table(parent_a, parent_b)
```

در این حالت نیز، ترکیب ستون‌های `parent_a` و `parent_b` در جدول والد باید دارای یک محدودیت `UNIQUE` ترکیبی باشد.

---

#### **۴. کنترل رفتار در زمان حذف یا به‌روزرسانی (ON DELETE / ON UPDATE)**

شما می‌توانید مشخص کنید که در صورت حذف یا به‌روزرسانی یک ردیف در جدول **والد**، چه اتفاقی برای ردیف‌های مرتبط در جدول **فرزند** بیفتد.

- **`ON DELETE NO ACTION` (رفتار پیش‌فرض):** این حالت که بسیار شبیه به `RESTRICT` است، جلوی حذف ردیف والد را تا زمانی که ردیف‌های فرزندی به آن ارجاع می‌دهند، می‌گیرد. تفاوت جزئی آن‌ها در زمان‌بندی بررسی محدودیت در داخل تراکنش‌هاست.

- **`ON DELETE CASCADE` (حذف آبشاری):** با انتخاب این گزینه، در صورت حذف یک ردیف از جدول والد، **تمام ردیف‌های مرتبط** در جدول فرزند نیز به صورت خودکار و آبشاری حذف خواهند شد.
  **هشدار بسیار مهم:** استفاده از `CASCADE` می‌تواند بسیار **خطرناک** باشد. یک عملیات حذف ساده در یک جدول سطح بالا، می‌تواند به صورت آبشاری منجر به حذف میلیون‌ها ردیف در جداول پایین‌دستی شود. استفاده از این گزینه نیازمند دقت و شناخت کامل مدل داده است.

- **`ON DELETE SET NULL` یا `ON DELETE SET DEFAULT`:** اگر ستون کلید خارجی در جدول فرزند `nullable` باشد، می‌توانید مشخص کنید که در صورت حذف ردیف والد، مقدار کلید خارجی در ردیف‌های فرزند به `NULL` یا یک مقدار پیش‌فرض تغییر کند. این کار باعث می‌شود ردیف‌های فرزند "یتیم" (orphaned) شوند که بعداً می‌توانید آن‌ها را مدیریت کنید.

```postgresql
CREATE TABLE cities (
	id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	state_id BIGINT,
	name TEXT NOT NULL,

	FOREIGN KEY (state_id) REFERENCES states(id) ON DELETE CASCADE
	--FOREIGN KEY (state_id) REFERENCES states(id) ON DELETE NO ACTION
	--FOREIGN KEY (state_id) REFERENCES states(id) ON DELETE RESTRICT
	--FOREIGN KEY (state_id) REFERENCES states(id) ON DELETE SET NULL
);
```

---

#### **۵. جمع‌بندی**

محدودیت کلید خارجی ابزاری حیاتی برای تضمین یکپارچگی داده‌ها در یک پایگاه داده رابطه‌ای است. این محدودیت تضمین می‌کند که ارجاعات بین جداول شما همیشه معتبر باقی بمانند. در استفاده از گزینه‌های پیشرفته‌ای مانند `ON DELETE CASCADE` باید بسیار محتاط بود. در بخش‌های آینده دوره، به نحوه ایندکس‌گذاری روی ستون‌های کلید خارجی برای افزایش سرعت `JOIN`ها خواهیم پرداخت.
