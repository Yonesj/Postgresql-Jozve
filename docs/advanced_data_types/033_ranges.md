### **جلسه ۳۳: انواع داده بازه (Range Types)**

محدوده‌ها یا بازه‌ها (Ranges) یک نوع داده مستقل نیستند، بلکه یک «فراداده» (meta type) محسوب می‌شوند که می‌توانند با انواع داده پایه‌ای دیگر مانند اعداد صحیح، تاریخ و زمان ترکیب شوند. یک بازه، مجموعه‌ای از مقادیر بین یک مرز پایینی و یک مرز بالایی را نشان می‌دهد.

---

#### **۱. معرفی بازه‌ها و کاربردهای آن‌ها**

یک بازه با یک مرز پایینی و یک مرز بالایی تعریف می‌شود. این مرزها می‌توانند شامل خود مقدار باشند (inclusive) یا نباشند (exclusive). همچنین، یک بازه می‌تواند از یک یا هر دو طرف بی‌کران (unbounded) باشد. بازه‌ها ابزارهای بسیار قدرتمندی برای کوئری‌نویسی هستند و می‌توانند مسائل پیچیده را ساده کنند. برای مثال، با استفاده از بازه‌ها می‌توان به راحتی بررسی کرد که آیا دو بازه زمانی (مانند دو رزرو برای یک اتاق هتل) با هم همپوشانی (overlap) دارند یا خیر. همچنین می‌توان با استفاده ازقید های تداخل (Exclusion Constraints) که در آینده به آن خواهیم پرداخت، از ثبت بازه‌های همپوشان در جدول جلوگیری کرد.

---

#### **۲. نحوه ایجاد بازه‌ها: کروشه و پرانتز**

برای تعریف یک بازه به صورت رشته‌ای، از دو نوع علامت استفاده می‌شود. کروشه `[]` به معنای "شامل خود مقدار" (inclusive) و پرانتز `()` به معنای "بدون احتساب خود مقدار" (exclusive) است. برای مثال، `[1,5]` بازه‌ای از ۱ تا ۵ را شامل خود این دو عدد نشان می‌دهد.

```postgresql
SELECT '[1,5]'::numrange; -- [1,5]
SELECT '[1,5)'::numrange; -- [1,5)

SELECT '[1,5]'::int4range; -- [1,6) == 1, 2, 3, 4, 5
SELECT '[1,5)'::int4range; -- [1,5)
```

---

#### **۳. تفاوت کلیدی: بازه‌های گسسته در مقابل بازه‌های پیوسته**

یک نکته بسیار مهم و کمی گیج‌کننده در مورد بازه‌ها، تفاوت رفتار آن‌ها بر اساس نوع داده زیربنایی است. برای مثال، اگر بازه `[1,5]` را به نوع `int4range` تبدیل کنیم، خروجی به `(1,6]` تغییر می‌کند. اما اگر همان بازه را به `numrange` تبدیل کنیم، به همان صورت `[1,5]` باقی می‌ماند.

دلیل این رفتار، تفاوت بین انواع داده **گسسته (discrete)** و **پیوسته (continuous)** است.

- **بازه‌های گسسته:** انواع داده‌ای مانند `integer` و `date` گسسته هستند، یعنی بین دو مقدار متوالی، مقدار دیگری وجود ندارد (بعد از ۱، عدد صحیح بعدی ۲ است). برای این نوع بازه‌ها، بازه `[1,5]` (از ۱ تا ۵، شامل خودشان) از نظر ریاضی با بازه `(1,6]` (از ۱ تا قبل از ۶) معادل است. PostgreSQL برای این نوع بازه‌ها یک فرمت استاندارد (canonical) را انتخاب می‌کند که معمولاً مرز پایینی شامل و مرز بالایی غیرشامل است.

- **بازه‌های پیوسته:** انواع داده‌ای مانند `numeric` و `timestamp` پیوسته هستند، یعنی بین هر دو مقدار، بی‌نهایت مقدار دیگر وجود دارد. برای این نوع بازه‌ها، بازه `[1,5]` با بازه `(1,6]` معادل **نیست**، زیرا مقادیری مانند `5.1` یا `5.99` در بازه دوم وجود دارند اما در اولی نه. به همین دلیل، PostgreSQL تعریف اصلی شما را برای بازه‌های پیوسته حفظ می‌کند.

---

#### **۴. استفاده از توابع سازنده (Constructor Functions)**

علاوه بر فرمت رشته‌ای، می‌توانید از توابع سازنده برای ایجاد بازه‌ها استفاده کنید. برای مثال `numrange(1, 5)`. رفتار پیش‌فرض این توابع، ایجاد بازه‌ای با مرز پایینی شامل و مرز بالایی غیرشامل است. شما می‌توانید با ارسال یک پارامتر سوم، این رفتار را کنترل کنید. برای مثال `numrange(1, 5, '[]')` بازه‌ای کاملاً شامل ایجاد می‌کند. این روش ممکن است برای استفاده‌های برنامه‌نویسی ساده‌تر باشد.

---

#### **۵. بازه‌های خاص: بی‌کران و تهی**

شما می‌توانید با خالی گذاشتن یکی از مرزها، یک بازه **بی‌کران (unbounded)** ایجاد کنید. برای مثال، بازه‌ای که از تاریخ مشخصی شروع شده و تا بی‌نهایت ادامه دارد. همچنین مفهومی به نام بازه **تهی (empty)** وجود دارد که نشان‌دهنده "هیچ بازه‌ای" است و با یک بازه بی‌کران که تمام مقادیر را شامل می‌شود، کاملاً متفاوت است.

---

#### **۶. اپراتورهای اصلی برای کوئری زدن روی بازه‌ها**

دو اپراتور بسیار پرکاربرد برای کار با بازه‌ها وجود دارد:

- **اپراتور شمول (`<@`)**: برای بررسی اینکه آیا یک مقدار خاص درون یک بازه قرار دارد، از این اپراتور استفاده می‌کنیم. (به آن a container operator نیز می گویند)
- **اپراتور همپوشانی (`&&`)**: برای بررسی اینکه آیا دو بازه با یکدیگر همپوشانی دارند یا خیر، از این اپراتور استفاده می‌شود.

<div class='centered-div'>
  <img src="../../assets/images/advanced_data_types/33_1.png">
</div>

---

#### **۷. دسترسی به مرزهای بازه**

با استفاده از توابع `()lower` و `()upper` می‌توانید به مرزهای پایینی و بالایی یک بازه دسترسی پیدا کنید. رفتار تابع `()upper` برای بازه‌های گسسته ممکن است کمی گیج‌کننده باشد. برای مثال `upper('[10,20]'::int4range)` مقدار `21` را برمی‌گرداند، زیرا مرز بالایی غیرشامل در فرمت استاندارد این بازه، `21` است. برای رفع ابهام، می‌توانید از توابع `()lower_inc` و `()upper_inc` استفاده کنید که یک مقدار بولین برمی‌گردانند و نشان می‌دهند که آیا مرز مورد نظر شامل خود مقدار هست یا خیر.

---

#### **۸. معرفی بازه‌های چندگانه (Multi-ranges)**

علاوه بر بازه‌های ساده، PostgreSQL از **بازه‌های چندگانه (multi-ranges)** نیز پشتیبانی می‌کند. یک بازه چندگانه، مجموعه‌ای از بازه‌های مجزا و **غیرپیوسته (non-contiguous)** است. برای مثال

```postgresql
SELECT '{[3,7), [8,9)}'::int4multirange @> 8; --true
SELECT '{[3,7), [8,9)}'::int4multirange @> 7; --false
```

---

#### **۹. لیست کامل انواع بازه و بازه چندگانه**

PostgreSQL انواع بازه و بازه چندگانه را برای انواع داده زیر پشتیبانی می‌کند:
`int4range`, `int8range`, `numrange`, `daterange`, `tsrange`, `tstzrange` و تمام نسخه‌های `multirange` متناظر با آن‌ها.

<div class='centered-div'>
  <img src="../../assets/images/advanced_data_types/33_2.png">
</div>

بازه‌ها یک قابلیت بسیار قدرتمند هستند که در صورت مواجهه با مسئله‌ای که نیاز به بررسی وجود یک نقطه در یک مجموعه پیوسته یا گسسته از نقاط دارد، راه‌حل ایده‌آل شما خواهند بود.
