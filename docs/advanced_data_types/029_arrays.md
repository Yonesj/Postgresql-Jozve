### **جلسه ۲۹: نوع داده آرایه (Array)**

در PostgreSQL علاوه بر آرایه‌هایی که در داخل ساختار JSON وجود دارند، می‌توانیم از آرایه‌ها به عنوان یک نوع داده مستقل و قدرتمند نیز استفاده کنیم. این نوع داده قابلیت‌های بسیار جالب و کارآمدی برای کوئری‌نویسی دارد که در بخش‌های آینده دوره به تفصیل به آن‌ها خواهیم پرداخت.

---

#### **۱. چه زمانی از آرایه استفاده کنیم؟ (مقایسه با جدول مجزا)**

تصمیم‌گیری بین استفاده از یک ستون آرایه یا ایجاد یک جدول مجزا برای داده‌های مرتبط، به مورد استفاده شما بستگی دارد.

- **کاربرد مناسب برای آرایه:** یک مثال خوب، ذخیره مجموعه‌ای از خوانش‌های یک سنسور است. اگر این خوانش‌ها همیشه به یک سنسور خاص در یک زمان مشخص تعلق دارند و شما معمولاً کل مجموعه را با هم بازیابی می‌کنید، استفاده از یک ستون آرایه کاملاً منطقی است. مثال دیگر می‌تواند ذخیره تگ‌های یک مقاله باشد که با این کار می‌توان از ایجاد یک جدول واسط (linking table) جلوگیری کرد.

- **معایب و چالش‌ها:** بزرگترین چالش استفاده از آرایه به جای جدول مجزا، از دست دادن **یکپارچگی ارجاعی (Referential Integrity)** است. برای مثال، اگر یک تگ از جدول اصلی تگ‌ها حذف شود، PostgreSQL به صورت خودکار آن تگ را از داخل آرایه‌هایی که در جداول دیگر ذخیره شده‌اند، حذف نخواهد کرد. این یک trade-off است که باید با توجه به نیاز خود در مورد آن تصمیم بگیرید.

---

#### **۲. نحوه ایجاد و تعریف ستون‌های آرایه**

برای تعریف یک ستون به عنوان آرایه، کافی است پس از مشخص کردن نوع داده عناصر، از براکت `[]` استفاده کنید. شما می‌توانید آرایه‌ای از هر نوع داده‌ای داشته باشید (اعداد صحیح، متن، بولین و...).

```postgresql
CREATE TABLE array_example (
	id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	int_array INTEGER[], -- same as int_array INTEGER ARRAY
	text_array TEXT[],
	bool_array BOOLEAN[],
	nested_array INTEGER[][]
);
```

همچنین می‌توانید از کلمه کلیدی `ARRAY` نیز استفاده کنید: `text_array TEXT ARRAY`.

---

#### **۳. فرمت‌های درج داده در آرایه**

دو فرمت اصلی برای وارد کردن داده به یک ستون آرایه وجود دارد:

1.  **فرمت با کلمه کلیدی `ARRAY`:** این فرمت خواناتر و واضح‌تر است. مثال:

```postgresql
    INSERT INTO
      array_example (int_array, text_array, bool_array)
    VALUES (
      ARRAY [1, 2, 3, 4],
      ARRAY ['marigold', 'daisy', 'poppy', 'sunflower'],
      ARRAY [true, false, true, false]
    );
```

2.  **فرمت با آکولاد `{}`:** این فرمت فشرده‌تر است و فرمت استاندارد خروجی PostgreSQL نیز محسوب می‌شود.

```postgresql
    INSERT INTO
      array_example (nested_array)
    VALUES (
      '{{1, 2, 3}, {4, 5, 6}, {7, 8, 9}}'
    );
```

وقتی داده‌ها را از یک ستون آرایه `SELECT` می‌کنید، PostgreSQL آن‌ها را با فرمت آکولاد به شما نمایش می‌دهد.

<div class="centered-div" style="padding: 1rem 0;">
<img src="../../assets/images/advanced_data_types/array_output_format.png" alt="array output fromat" />
</div>

---

#### **۴. مقدمه‌ای بر اپراتورها و توابع کار با آرایه**

اگرچه بحث کامل کوئری‌نویسی در جلسات آینده خواهد بود، اما در اینجا با چند اپراتور و تابع کلیدی آشنا می‌شویم.

4.1. **دسترسی به عناصر:**

```postgresql
  SELECT id, text_array[0] FROM array_example;

  -- id | text_array
  ------------------
  --  1 |	NULL
  --  2 |	NULL

  SELECT id, text_array[1] FROM array_example;

  -- id | text_array
  ------------------
  --  1 |	marigold
  --  2 |	NULL
```

یک نکته بسیار عجیب و مهم این است که اندیس‌گذاری در آرایه‌های PostgreSQL از **یک** شروع می‌شود، نه از صفر. این رفتار با آرایه‌های JSON در خود PostgreSQL (که صفر-مبنا هستند) متفاوت است. برای دسترسی به اولین عنصر، باید از `[1]` استفاده کنید.

<br/>

4.2. **برش زدن (Slicing):** شما می‌توانید بخشی از آرایه را با مشخص کردن یک محدوده استخراج کنید. برای مثال `[1:3]` (از عنصر اول تا سوم)، `[3:]` (تا عنصر سوم) یا `[:3]` (از عنصر سوم به بعد).

```postgresql
  SELECT id, text_array[2:] FROM array_example;

  -- id | text_array
  ------------------
  --  1 |	{daisy,poppy,sunflower}
  --  2 |	NULL
```

<br/>

4.3. **اپراتور عضویت (`<@`):**
با این اپراتور بررسی می کنیم که آیا آرایه سمت چپ، آرایه سمت راست را شامل می شود یا خیر.

```postgresql
SELECT id, text_array FROM array_example WHERE text_array @> '{poppy}';

-- id | text_array
------------------
--  1 |	{marigold,daisy,poppy,sunflower}
```

<br/>

4.4. **تابع `()unnest`:** این یکی از قدرتمندترین توابع کار با آرایه است. تابع `()unnest` یک ستون آرایه را گرفته و آن را به مجموعه‌ای از **ردیف‌ها (rows)** تبدیل می‌کند. هر عنصر آرایه به یک ردیف جداگانه تبدیل می‌شود. این کار به شما اجازه می‌دهد تا از "دنیای آرایه‌ها" خارج شده و به "دنیای SQL" بازگردید و بتوانید روی عناصر آرایه مانند یک جدول معمولی، عملیات `JOIN`، `WHERE` و... انجام دهید.

```postgresql
SELECT id, UNNEST(text_array) FROM array_example;

-- id | unnest
------------------
--  1 |	marigold
--  1 |	daisy
--  1 |	poppy
--  1 |	sunflower
```

---

#### **۵. جمع‌بندی**

آرایه‌ها یک نوع داده بسیار قدرتمند و کاربردی در PostgreSQL هستند که در صورت استفاده صحیح، می‌توانند به ساده‌سازی مدل داده و کوئری‌ها کمک کنند. با این حال، همیشه باید به بده‌بستان‌های آن، به خصوص در مورد یکپارچگی ارجاعی، توجه داشته باشید. در جلسات آینده به نحوه ایندکس‌گذاری و کوئری‌نویسی پیشرفته روی آرایه‌ها خواهیم پرداخت.
