### **جلسه ۳۴: انواع داده ترکیبی (Composite Types)**

در این جلسه به بررسی انواع داده ترکیبی (Composite Types) می‌پردازیم، اما قبل از شروع یک هشدار مهم وجود دارد: این نوع داده احتمالاً چیزی نیست که شما به آن نیاز داشته باشید. انواع ترکیبی جالب و قدرتمند هستند، اما کاربرد بسیار کمی دارند.

---

#### **۱. نوع داده ترکیبی چیست؟**

یک نوع داده ترکیبی، مجموعه‌ای از انواع داده استاندارد PostgreSQL را در قالب یک **نوع داده واحد و مجزا** بسته‌بندی می‌کند. می‌توان آن را به عنوان یک واحد اطلاعاتی فشرده و جدایی‌ناپذیر در نظر گرفت. یک مثال خوب برای کاربرد آن، افزونه PostGIS است که گاهی یک نوع داده `address` را برمی‌گرداند که خود شامل چندین فیلد مختلف (مانند خیابان، شهر، و غیره) است.

با این حال، در اکثر موارد، راهکارهای بهتری برای مدل‌سازی این نوع داده‌ها وجود دارد. شما معمولاً می‌توانید از ستون‌های مجزا، یک شیء JSON یا حتی یک جدول کاملاً جداگانه برای نگهداری این اطلاعات استفاده کنید.

---

#### **۲. نحوه ایجاد یک نوع داده ترکیبی**

ایجاد یک نوع داده ترکیبی با دستور `CREATE TYPE` انجام می‌شود. سینتکس آن شبیه به تعریف یک جدول است، اما باید از کلمه کلیدی `AS` استفاده کنید. در داخل پرانتزها، فیلدهای مختلف را به همراه نوع داده واقعی آن‌ها تعریف می‌کنید.

```postgresql
CREATE TYPE address AS (
	number TEXT,
	street TEXT,
	city TEXT,
	postal TEXT
);
```

**نکته مهم:** شما **نمی‌توانید** در تعریف یک نوع داده ترکیبی، از محدودیت‌هایی (constraints) مانند `NOT NULL` استفاده کنید. این محدودیت‌ها باید در سطح تعریف جدول اعمال شوند.

---

#### **۳. نحوه ایجاد و مقداردهی یک مقدار از نوع ترکیبی**

برای ایجاد یک نمونه از نوع داده ترکیبی خود، می‌توانید از سینتکس `ROW` استفاده کنید. این روش خواناترین و بهترین راه است.

```postgresql
SELECT ROW('123', 'Main St', 'Tehran', '12345')::address;
SELECT ('123', 'Main St', 'Tehran', '12345')::address; -- equivalent
```

شما می‌توانید کلمه کلیدی `ROW` را حذف کرده و فقط از پرانتز استفاده کنید، اما استفاده از فرمت رشته‌ای برای ایجاد این نوع داده به دلیل مشکلات مربوط به کوتیشن‌های تودرتو توصیه نمی‌شود.

---

#### **۴. استفاده از انواع ترکیبی در جداول**

پس از تعریف نوع داده ترکیبی، می‌توانید از آن به عنوان نوع داده یک ستون در جدول خود استفاده کنید.

```postgresql
CREATE TABLE shops (
	id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	addr address
);
```

سپس می‌توانید با استفاده از همان سینتکس `ROW`، یک مقدار کامل را در این ستون درج کنید.

```postgresql
INSERT INTO shops (addr) VALUES (ROW('123', 'Main St', 'Tehran', '12345'));
```

---

#### **۵. نحوه دسترسی به فیلدهای داخلی یک نوع ترکیبی**

برای دسترسی به فیلدهای داخلی یک ستون از نوع ترکیبی، باید از یک سینتکس خاص استفاده کنید. شما **نمی‌توانید** مستقیماً به صورت `addr.number` به فیلد دسترسی پیدا کنید، زیرا PostgreSQL کلمه `addr` را به عنوان نام یک جدول تفسیر می‌کند.

**راه حل صحیح:** باید نام ستون را در داخل **پرانتز** قرار دهید و سپس با استفاده از نقطه (`.`) به فیلد مورد نظر دسترسی پیدا کنید.

```postgresql
SELECT id, (addr).number FROM shops;
-- id | number
--------------
--  1 |    123
```

---

#### **۶. جمع‌بندی**

انواع داده ترکیبی یک قابلیت جالب اما بسیار کم‌کاربرد هستند. شما ممکن است در خروجی برخی افزونه‌ها (مانند PostGIS) با آن‌ها مواجه شوید، بنابراین دانستن وجود آن‌ها و نحوه دسترسی به فیلدهایشان مفید است. اما در اکثر مواقع برای مدل‌سازی داده‌های خود، راهکارهای بهتری مانند ستون‌های مجزا یا JSON وجود دارد.
