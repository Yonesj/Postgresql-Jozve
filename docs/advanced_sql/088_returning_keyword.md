در جلسه قبل با `Upsert` آشنا شدیم که به ما اجازه می‌دهد عملیات `INSERT` یا `UPDATE` را در یک دستور واحد انجام دهیم. اما یک چالش باقی می‌ماند: پس از اجرای `Upsert`، چگونه از مقدار جدید ستون‌ها مطلع شویم؟ آیا باید یک کوئری `SELECT` جداگانه اجرا کنیم؟ خوشبختانه، پاسخ منفی است.

---

### **۱. معرفی `RETURNING`: بازگرداندن مقادیر در همان کوئری**

کلمه کلیدی `RETURNING` به شما اجازه می‌دهد تا در انتهای دستورات تغییر داده (`INSERT`, `UPDATE`, `DELETE` و `Upsert`)، مقادیر ردیف‌هایی را که تحت تأثیر قرار گرفته‌اند، بازگردانید. این قابلیت شما را از اجرای یک کوئری اضافی برای واکشی نتایج بی‌نیاز می‌کند و باعث کاهش رفت و برگشت به پایگاه داده و افزایش کارایی می‌شود.

**مثال با `Upsert`:**

```postgresql
INSERT INTO kv (key, value) VALUES ('hits', 1)
ON CONFLICT (key) DO UPDATE SET value = kv.value + 1
RETURNING *;
```

با افزودن `* RETURNING`، پس از هر بار اجرای این کوئری (چه در حالت `INSERT` و چه در حالت `UPDATE`)، کل ردیف به‌روز شده به شما بازگردانده می‌شود و شما بلافاصله از مقدار جدید شمارنده مطلع می‌شوید. شما می‌توانید به جای `*`، فقط ستون‌های مورد نظر خود را مشخص کنید (مانند `RETURNING value`).

---

### **۲. کاربرد `RETURNING` با `DELETE`**

`RETURNING` با دستور `DELETE` نیز بسیار مفید است. شما می‌توانید ردیف‌هایی را که در حال حذف آن‌ها هستید، بازگردانید.

```postgresql
DELETE FROM kv WHERE ... RETURNING *;
```

این ویژگی به خصوص زمانی کاربرد دارد که شما در حال حذف ردیف‌های منقضی شده (مثلاً بر اساس یک `expires_at`) هستید و می‌خواهید بدانید دقیقاً چه ردیف‌هایی حذف شده‌اند، بدون اینکه نیاز به نگهداری یک کپی از داده‌ها در سمت اپلیکیشن داشته باشید.

---

### **۳. مهم‌ترین کاربرد `RETURNING`: بازگرداندن مقادیر تولید شده خودکار**

یکی از قدرتمندترین و رایج‌ترین کاربردهای `RETURNING`، بازگرداندن مقادیری است که تولید آن‌ها بر عهده PostgreSQL بوده است. این مقادیر می‌توانند شامل موارد زیر باشند:

*   **کلیدهای اصلی خودافزا (`IDENTITY` یا `SERIAL`)**
*   **ستون‌های تولیدی (`Generated Columns`)**
*   **مقادیر پیش‌فرض (`DEFAULT`) مانند `CURRENT_TIMESTAMP`**

**مثال با `INSERT`:**
وقتی یک ردیف جدید در جدول `bookmarks` درج می‌کنید، `id` آن به صورت خودکار توسط PostgreSQL تولید می‌شود. برای اینکه بلافاصله پس از درج، به این `id` دسترسی داشته باشید (مثلاً برای هدایت کاربر به صفحه ویرایش آن بوکمارک)، می‌توانید از `RETURNING` استفاده کنید.

```postgresql
INSERT INTO bookmarks (user_id, url) 
VALUES (1, '...')
RETURNING *;
```

این کوئری نه تنها ردیف جدید را درج می‌کند، بلکه کل آن ردیف (شامل `id` تولید شده) را در همان پاسخ به شما بازمی‌گرداند.

---

### **۴. جمع‌بندی**

کلمه کلیدی `RETURNING` یک ابزار فوق‌العاده کارآمد برای بازگرداندن مقادیر ردیف‌های تحت تأثیر در دستورات `INSERT`, `UPDATE` و `DELETE` است. این قابلیت به شما اجازه می‌دهد تا مسئولیت محاسبه یا تولید مقادیر را به PostgreSQL بسپارید و سپس در همان کوئری، نتیجه کار را دریافت کنید. این کار باعث ساده‌سازی کد، کاهش بار شبکه و افزایش عملکرد اپلیکیشن شما می‌شود.