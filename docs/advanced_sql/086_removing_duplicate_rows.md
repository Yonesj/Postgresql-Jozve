در این جلسه، با استفاده از یک تابع پنجره‌ای و یک `CTE`، یاد می‌گیریم چگونه ردیف‌های تکراری را در یک جدول شناسایی کرده و سپس آن‌ها را حذف کنیم.

---

#### **۱. سناریو و مشکل: داده‌های تکراری**

فرض کنید در جدول `bookmarks`، به دلیل عدم وجود یک محدودیت `UNIQUE` روی ترکیب `(user_id, url)`، یک کاربر توانسته است یک URL یکسان را چندین بار بوکمارک کند. اکنون ما با داده‌های تکراری مواجه هستیم و می‌خواهیم آن‌ها را پاکسازی کنیم، به طوری که از هر بوکمارک تکراری، فقط **یک نسخه** باقی بماند.

---

#### **۲. گام اول: شناسایی ردیف‌های تکراری با تابع پنجره‌ای**

برای شناسایی ردیف‌های تکراری، از تابع پنجره‌ای `()ROW_NUMBER` استفاده می‌کنیم.

1.  **پارتیشن‌بندی:** ما مجموعه نتایج را بر اساس ستون‌هایی که باید منحصر به فرد باشند، پارتیشن‌بندی می‌کنیم. در این مثال، `PARTITION BY user_id, url`. با این کار، تمام ردیف‌هایی که `user_id` و `url` یکسانی دارند، در یک پارتیشن واحد قرار می‌گیرند.
2.  **شماره‌گذاری:** تابع `()ROW_NUMBER` به هر ردیف در داخل پارتیشن خود یک شماره متوالی اختصاص می‌دهد.

```postgresql
SELECT *, ROW_NUMBER() OVER (PARTITION BY user_id, url) FROM bookmarks;
```

نتیجه این کوئری به ما نشان می‌دهد که برای هر گروه از ردیف‌های تکراری، ردیف اول شماره `1` را می‌گیرد و ردیف‌های بعدی شماره‌های `2`, `3` و الی آخر را دریافت می‌کنند. بنابراین، **تمام ردیف‌هایی که شماره آن‌ها بزرگتر از ۱ است، تکراری و قابل حذف هستند.**

---

#### **۳. گام دوم: استفاده از `CTE` برای کپسوله کردن منطق**

ما نتیجه کوئری بالا را در داخل یک `CTE` (مثلاً به نام `duplicates_identified`) قرار می‌دهیم. این کار به ما اجازه می‌دهد تا در مرحله بعد، به راحتی روی نتایج این شناسایی کار کنیم.

```postgresql
WITH duplicates_identified AS (
	SELECT 
		id, 
		ROW_NUMBER() OVER (PARTITION BY user_id, url) > 1 AS is_duplicated
	FROM bookmarks
)
```

---

#### **۴. گام سوم: حذف ردیف‌های تکراری**

 یک راه بسیار تمیز برای این کار، استفاده از `DELETE` به همراه یک شرط `IN` است که `id` ردیف‌های تکراری را از `CTE` ما انتخاب می‌کند.

```postgresql
DELETE FROM bookmarks WHERE id IN (
	SELECT id 
	FROM duplicates_identified 
	WHERE is_duplicated is TRUE
);
```

این کوئری تمام ردیف‌های تکراری را در یک مرحله و به صورت کاملاً کارآمد حذف می‌کند و فقط اولین نسخه از هر بوکمارک را باقی می‌گذارد.

---

#### **۵. جمع‌بندی**

این الگو (ترکیب تابع پنجره‌ای `()ROW_NUMBER` با `PARTITION BY` برای شناسایی تکراری‌ها و سپس استفاده از `CTE` برای حذف آن‌ها) یک روش استاندارد، قدرتمند و بسیار کارآمد برای پاکسازی داده‌های تکراری در PostgreSQL است. این روش به شما اجازه می‌دهد تا کل فرآیند را در یک کوئری واحد و بدون نیاز به انتقال داده به اپلیکیشن و پردازش در آنجا، انجام دهید.