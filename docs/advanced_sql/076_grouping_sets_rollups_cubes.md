### **جلسه ۷۶: مجموعه‌های گروه‌بندی، Rollups و Cubes**

PostgreSQL از روش‌های گروه‌بندی بسیار پیچیده‌تری با استفاده از `GROUPING SETS`، `ROLLUP` و `CUBE` پشتیبانی می‌کند. این قابلیت‌ها که ممکن است برای کاربران Microsoft Excel آشنا باشند، به ما اجازه می‌دهند تا چندین سطح از تجمیع (aggregation) داده را در یک کوئری واحد انجام دهیم.

---

#### **۱. `GROUPING SETS`: گروه‌بندی دستی و انعطاف‌پذیر**

`GROUPING SETS` به شما اجازه می‌دهد تا به صورت دستی و صریح، **مجموعه‌های مختلفی از ستون‌ها** را که می‌خواهید بر اساس آن‌ها گروه‌بندی انجام شود، تعریف کنید.

**مثال:** فرض کنید می‌خواهیم مجموع فروش را یک بار به تفکیک هر کارمند، یک بار به تفکک هر منطقه، و یک بار به صورت کلی (مجموع کل) محاسبه کنیم.

```postgresql
SELECT employee_id, region, SUM(amount)
FROM sales
GROUP BY GROUPING SETS ((employee_id), (region), ());
```

در خروجی این کوئری، PostgreSQL برای هر سطح از گروه‌بندی، ستون‌هایی را که در آن سطح نقشی ندارند، با `NULL` پر می‌کند. برای مثال، در ردیف‌هایی که بر اساس `region` گروه‌بندی شده‌اند، ستون `employee_id` برابر `NULL` خواهد بود.

??? note "خروجی کوئری بالا"
    <div class='centered-div'>
      <img width="70%" height="auto" src="../../assets/images/advanced_sql/76.png">
    </div>

`GROUPING SETS` انعطاف‌پذیرترین روش است، زیرا به شما کنترل کامل بر روی تمام ترکیب‌های گروه‌بندی را می‌دهد.

*   **گروه‌بندی کلی:** یک مجموعه خالی `()` در `GROUPING SETS` به معنای گروه‌بندی روی کل مجموعه داده و محاسبه مجموع کل است. (ردیف اول در خروجی بالا)
*   **گروه‌بندی ترکیبی:** هر مجموعه در `GROUPING SETS` می‌تواند شامل چند ستون باشد، مانند `(employee_id, region)`.

---

#### **۲. `ROLLUP`: گروه‌بندی سلسله‌مراتبی**

`ROLLUP` یک نوشتار خلاصه‌تر برای ایجاد `GROUPING SETS` به صورت **سلسله‌مراتبی** است. این ابزار برای گزارش‌هایی که در آن‌ها جزئیات به تدریج به سطوح بالاتر و کلی‌تر "جمع‌بندی" می‌شوند، بسیار مفید است.

```postgresql
ROLLUP(region, employee_id)
```

این دستور معادل `GROUPING SETS` زیر است:

```postgresql
GROUPING SETS ((region, employee_id), (region), ())
```

`ROLLUP` از سمت راست به چپ عمل می‌کند: ابتدا بر اساس تمام ستون‌ها (`region, employee_id`) گروه‌بندی می‌کند، سپس آخرین ستون را حذف کرده و بر اساس `region` گروه‌بندی می‌کند، و این کار را تا رسیدن به یک مجموعه خالی (مجموع کل) ادامه می‌دهد.

---

#### **۳. `CUBE`: تمام ترکیب‌های ممکن**

`CUBE` یک نوشتار خلاصه‌تر دیگر است که **تمام ترکیب‌های ممکن** از ستون‌های داده شده را برای گروه‌بندی ایجاد می‌کند.

```postgresql
CUBE(employee_id, region)
```

این دستور معادل `GROUPING SETS` زیر است:

```postgresql
GROUPING SETS ((employee_id, region), (employee_id), (region), ())
```

`CUBE` برای تحلیل‌های داده چندبعدی که در آن‌ها نیاز به مشاهده تجمیع داده‌ها از تمام زوایای ممکن دارید، بسیار قدرتمند است. با افزایش تعداد ستون‌ها، تعداد گروه‌بندی‌های تولید شده توسط `CUBE` به سرعت افزایش می‌یابد.

---

#### **۴. جمع‌بندی مقایسه‌ای**

*   **`GROUPING SETS`:** روش دستی و کاملاً انعطاف‌پذیر که در آن شما تمام ترکیب‌های مورد نظر را به صراحت تعریف می‌کنید.
*   **`ROLLUP`:** برای گروه‌بندی‌های سلسله‌مراتبی (از جزئی به کل).
*   **`CUBE`:** برای ایجاد تمام ترکیب‌های ممکن از گروه‌بندی.

این ابزارها به شما قدرت فوق‌العاده‌ای برای انجام تجمیع داده‌های پیچیده در یک کوئری واحد می‌دهند و نیاز به اجرای چندین کوئری مجزا و ترکیب نتایج در سطح اپلیکیشن را از بین می‌برند.
