### **جلسه ۵۳: ایندکس‌های تابعی (Functional Indexes)**

تا به اینجا، تمام ایندکس‌هایی که ساخته‌ایم روی یک یا چند ستون بوده‌اند. اما یک قابلیت بسیار قدرتمند دیگر نیز وجود دارد: **ایجاد ایندکس روی نتیجه یک تابع یا عبارت (expression)**.

---

#### **۱. ایندکس تابعی چیست؟**

یک ایندکس تابعی (که به آن expression index نیز می‌گویند) شباهت زیادی به ستون‌های تولیدی (generated columns) دارد. اما به جای اینکه نتیجه تابع در یک ستون جدید ذخیره شود، مستقیماً در ساختار B-Tree یک ایندکس ذخیره می‌شود.

این کار به پایگاه داده اجازه می‌دهد که هنگام جستجو، به جای محاسبه مجدد تابع برای هر ردیف، مستقیماً مقدار از پیش محاسبه شده را در ایندکس جستجو کند. هر بار که یک ردیف درج، به‌روزرسانی یا حذف می‌شود، تابع دوباره ارزیابی شده و مقدار جدید در ایندکس B-Tree قرار می‌گیرد.

---

#### **۲. نحوه ایجاد یک ایندکس تابعی**

برای ایجاد یک ایندکس تابعی، باید عبارت یا تابع مورد نظر خود را در داخل یک **پرانتز اضافی** در تعریف ایندکس قرار دهید. این پرانتز اضافی به PostgreSQL می‌فهماند که شما در حال ایندکس‌گذاری روی یک عبارت هستید، نه یک ستون.

**مثال: ایندکس روی دامنه ایمیل**
در جلسات قبل، از ستون تولیدی برای استخراج دامنه ایمیل استفاده کردیم. اکنون همان کار را با یک ایندکس تابعی انجام می‌دهیم:

```postgresql
CREATE INDEX domain_idx ON users ((split_part(email, '@', 2)));
```

با ایجاد این ایندکس، اگر کوئری شما دقیقاً از همان تابع در شرط `WHERE` خود استفاده کند، PostgreSQL می‌تواند از ایندکس برای پیدا کردن سریع نتایج بهره ببرد.

```postgresql
WHERE (split_part(email, '@', 2)) = 'beer.com'
```

**نکته حیاتی:** برای اینکه ایندکس استفاده شود، **عبارت موجود در `WHERE` باید دقیقاً با عبارت تعریف شده در ایندکس مطابقت داشته باشد.**

---

#### **۳. مزیت بزرگ ایندکس‌های تابعی**

یکی از مزایای فوق‌العاده ایندکس‌های تابعی این است که شما می‌توانید بدون هیچ تغییری در کد اپلیکیشن، عملکرد آن را بهبود ببخشید. اگر یک سیستم خارجی یا یک کتابخانه که کنترلی روی آن ندارید، کوئری‌هایی با توابع خاص اجرا می‌کند، شما می‌توانید به سادگی یک ایندکس تابعی متناظر با آن در پایگاه داده خود ایجاد کرده و سرعت اجرای آن کوئری‌ها را به طرز چشمگیری افزایش دهید.

---

#### **۴. کاربردهای رایج ایندکس‌های تابعی**

- **ایندکس‌گذاری روی بخشی از JSON:** یکی از رایج‌ترین کاربردها، استخراج یک کلید پرتکرار از یک ستون JSON و ایجاد ایندکس روی آن است.
- **ایندکس‌گذاری غیرحساس به حروف بزرگ و کوچک (Case-Insensitive):**
  برای پیاده‌سازی جستجوی غیرحساس به حروف روی یک ستون (مثلاً `email`)، می‌توانید یک ایندکس روی نسخه کوچک‌شده آن ستون ایجاد کنید.

  ```postgresql
  CREATE INDEX email_lower_idx ON users ((lower(email)));
  ```

  سپس، برای استفاده از این ایندکس، باید در کوئری خود نیز از همان تابع `lower` هم روی ستون و هم روی مقدار ورودی کاربر استفاده کنید.

  ```postgresql
  WHERE (lower(email)) = lower('AARON.FRANCIS@example.com')
  ```

---

#### **۵. جمع‌بندی**

ایندکس‌های تابعی یک ابزار فوق‌العاده قدرتمند هستند که می‌توانند عملکرد کوئری‌های پیچیده را به شدت بهبود بخشند. یادگیری نحوه استفاده صحیح از آن‌ها، دانش شما را در زمینه مدیریت پایگاه داده به سطح بالاتری ارتقا می‌دهد و به شما برای بهینه‌سازی سیستم‌ها قدرت می‌بخشد.
