### **جلسه ۵۵: ایندکس‌های هش (Hash Indexes)**

اگرچه هنوز کارمان با ایندکس‌های B-Tree تمام نشده است، اما در این جلسه به سراغ نوع دیگری از ایندکس، یعنی **ایندکس هش (hash index)**، می‌رویم.

---

#### **۱. ایندکس هش چیست و چه کاربردی دارد؟**

یک ایندکس هش، نوعی ایندکس است که فقط و فقط برای جستجوهای مبتنی بر **برابری مطلق (strict equality)** بهینه شده است.

- **محدودیت‌های کلیدی:**
  از ایندکس هش **نمی‌توان** برای مرتب‌سازی (`ordering`)، جستجوهای بازه‌ای (`range searches`) یا جستجو با الگو (`wildcard searches` مانند `LIKE`) استفاده کرد.

- **دلیل محدودیت:**
  دلیل این محدودیت‌ها این است که ایندکس هش، مقدار واقعی ستون را ذخیره نمی‌کند. در عوض، مقدار ستون را از یک تابع هش عبور داده و **مقدار هش شده** آن را در یک ساختار داده متفاوت (که برای ذخیره این هش‌ها بهینه شده) ذخیره می‌کند. با این کار، معنای اصلی و ترتیب مقادیر از بین می‌رود و فقط امکان مقایسه برای برابری مطلق باقی می‌ماند.

---

#### **۲. مزایای ایندکس‌های هش**

- **سرعت بالا در برابری مطلق:** برای جستجوهای برابری مطلق، ایندکس هش معمولاً سریع‌تر از ایندکس B-Tree عمل می‌کند.
- **اندازه ثابت و فشرده:** یکی از بزرگترین مزایای ایندکس هش این است که مقدار هش شده همیشه یک اندازه ثابت دارد، صرف نظر از اینکه مقدار اصلی چقدر بزرگ باشد (یک متن طولانی یا یک URL چند هزار کاراکتری). این باعث می‌شود که ساختار ایندکس بسیار کوچک و فشرده باقی بماند.

---

#### **۳. نحوه ایجاد و مقایسه با B-Tree**

برای ایجاد یک ایندکس هش، باید به صراحت نوع آن را با استفاده از `USING HASH` مشخص کنید.

```postgresql
CREATE INDEX email_hash ON users USING HASH (email);
```

برای مقایسه، یک ایندکس B-Tree نیز روی همان ستون ایجاد می‌کنیم. سپس یک کوئری با شرط برابری مطلق اجرا می‌کنیم:

```postgresql
CREATE INDEX email_btree ON users USING btree (email);
EXPLAIN SELECT * FROM users WHERE email = 'aaron.francis@example.com';
```

`EXPLAIN` نشان می‌دهد که PostgreSQL هوشمندانه **ایندکس هش** را برای این کوئری انتخاب می‌کند، زیرا برای این کار سریع‌تر است. اما به محض اینکه شرط را به یک شرط بازه‌ای (`<`) یا `LIKE` تغییر دهیم، PostgreSQL دیگر نمی‌تواند از ایندکس هش استفاده کند و به سراغ ایندکس B-Tree یا حتی پیمایش کامل جدول می‌رود.

<div class='centered-div'>
  <img src="../../assets/images/advanced_indexing/55.png">
</div>

---

#### **۴. یک هشدار تاریخی مهم**

در نسخه‌های PostgreSQL **قبل از نسخه ۱۰**، ایندکس‌های هش مشکلات جدی داشتند. آن‌ها در گزارش پیش‌نویس (write-ahead log) ثبت نمی‌شدند، در فرآیند تکثیر (replication) اختلال ایجاد می‌کردند و حتی می‌توانستند باعث از کار افتادن (crash) سرور شوند. به همین دلیل، استفاده از آن‌ها به شدت منع می‌شد.

**این مشکلات به طور کامل در PostgreSQL 10 و نسخه‌های بعد از آن حل شده‌اند** و اکنون ایندکس‌های هش یک گزینه امن و قابل استفاده هستند.

---

#### **۵. موارد استفاده مناسب برای ایندکس هش**

با در نظر گرفتن محدودیت‌ها و مزایای آن، ایندکس هش برای موارد زیر می‌تواند یک گزینه عالی باشد:

- ستون‌هایی با مقادیر بسیار بزرگ که اغلب بر اساس برابری مطلق جستجو می‌شوند (مانند **URL**ها).
- آدرس‌های **ایمیل**.
- توکن‌های **API**.

در نهایت، شما باید هر دو روش (B-Tree و Hash) را روی داده‌ها و کوئری‌های واقعی خود تست کنید تا ببینید کدام یک برای مورد استفاده شما عملکرد بهتری دارد. اما اگر نیاز به جستجوی برابری مطلق بسیار سریع دارید، ایندکس هش را حتماً در نظر بگیرید.
