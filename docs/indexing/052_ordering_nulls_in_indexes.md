### **جلسه ۵۲: ترتیب‌دهی مقادیر `NULL` در ایندکس‌ها**

علاوه بر کنترل جهت صعودی یا نزولی، ما گزینه‌ دیگری نیز برای کنترل ترتیب‌دهی در کوئری‌ها و ایندکس‌ها داریم و آن، تعیین محل قرارگیری مقادیر **`NULL`** در مجموعه نتایج است.

---

#### **۱. رفتار پیش‌فرض مقادیر `NULL` در مرتب‌سازی**

به صورت پیش‌فرض در PostgreSQL، مقادیر `NULL` **بزرگتر از هر مقدار دیگری** در نظر گرفته می‌شوند. این رفتار نتایج زیر را به همراه دارد:

- **در مرتب‌سازی صعودی (`ASC`):** مقادیر `NULL` در **انتهای** نتایج قرار می‌گیرند.
- **در مرتب‌سازی نزولی (`DESC`):** مقادیر `NULL` در **ابتدای** نتایج قرار می‌گیرند.

این رفتار پیش‌فرض ممکن است چیزی نباشد که شما همیشه به دنبال آن هستید.

---

#### **۲. کنترل محل `NULL`ها در کوئری با `NULLS FIRST` و `NULLS LAST`**

شما می‌توانید با استفاده از عبارات `NULLS FIRST` و `NULLS LAST` در انتهای `ORDER BY`، رفتار پیش‌فرض را تغییر داده و به صراحت مشخص کنید که `NULL`ها در ابتدا یا انتهای نتایج قرار بگیرند.

- `ORDER BY birthday ASC NULLS FIRST`: مرتب‌سازی صعودی، اما `NULL`ها در ابتدا قرار می‌گیرند.
- `ORDER BY birthday DESC NULLS LAST`: مرتب‌سازی نزولی، اما `NULL`ها در انتها قرار می‌گیرند.

---

#### **۳. ایجاد ایندکس با ترتیب `NULL` سفارشی**

قدرت واقعی زمانی آشکار می‌شود که شما می‌توانید این ترتیب سفارشی را در **تعریف ایندکس** خود نیز منعکس کنید. این کار به PostgreSQL اجازه می‌دهد تا از ایندکس برای اجرای کوئری‌های مرتب‌سازی که از `NULLS FIRST` یا `NULLS LAST` استفاده می‌کنند، به صورت بهینه بهره ببرد.

برای این کار، کافی است عبارت مورد نظر را به تعریف ستون در ایندکس اضافه کنید:

```postgresql
CREATE INDEX birthday_nulls_first ON users (birthday ASC NULLS FIRST);
```

پس از ایجاد این ایندکس، اگر یک کوئری دقیقاً با همین ترتیب (`ORDER BY birthday ASC NULLS FIRST`) اجرا شود، PostgreSQL می‌تواند از یک `Index Scan` سریع استفاده کند. اما اگر ترتیب `NULL` در کوئری با ایندکس مطابقت نداشته باشد (مثلاً `NULLS LAST`)، ایندکس دیگر قابل استفاده نخواهد بود و PostgreSQL به سراغ روش‌های پرهزینه‌تر مانند پیمایش کامل جدول (`Seq Scan`) خواهد رفت.

---

#### **۴. ترکیب با پیمایش معکوس**

تمام قوانینی که در مورد پیمایش معکوس ایندکس یاد گرفتیم، در اینجا نیز صادق است. اگر شما یک ایندکس را به صورت `ASC NULLS FIRST` ایجاد کنید، یک کوئری با ترتیب کاملاً معکوس (`DESC NULLS LAST`) همچنان می‌تواند از ایندکس به صورت بهینه و با `Index Scan Backwards` استفاده کند.

مشکل زمانی رخ می‌دهد که فقط یکی از این دو بخش (جهت `ASC`/`DESC` یا ترتیب `NULL`) با تعریف ایندکس مطابقت نداشته باشد. در این حالت، ایندکس دیگر کارایی خود را از دست می‌دهد.

---

#### **۵. جمع‌بندی و توصیه نهایی**

اگر در کوئری‌های خود به طور مکرر از `NULLS FIRST` یا `NULLS LAST` برای کنترل محل قرارگیری مقادیر `NULL` استفاده می‌کنید، باید به طور جدی به فکر ایجاد یک ایندکس که دقیقاً همان ترتیب را منعکس می‌کند، باشید. این کار به شما کمک می‌کند تا از مرتب‌سازی‌های پرهزینه جلوگیری کرده و عملکرد کوئری‌های خود را به حداکثر برسانید.
