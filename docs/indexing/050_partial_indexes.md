### **جلسه ۵۰: ایندکس‌های جزئی (Partial Indexes)**

در جلسه مربوط به گزینش‌پذیری، گفتیم که اگر توزیع داده در یک ستون به شدت چوله (skewed) باشد، ممکن است ایندکس‌گذاری روی آن ایده خوبی باشد. اما یک گزینه بهتر و هوشمندانه‌تر نیز وجود دارد: **ایندکس جزئی (Partial Index)**. این یک قابلیت بسیار جالب در PostgreSQL (و SQLite) است که در MySQL وجود ندارد.

---

#### **۱. ایندکس جزئی چیست؟**

یک ایندکس جزئی به شما اجازه می‌دهد تا یک ایندکس را فقط روی **بخشی از ردیف‌های یک جدول** ایجاد کنید. به عبارت دیگر، شما می‌توانید با افزودن یک شرط `WHERE` (که به آن `predicate` می‌گویند) به تعریف ایندکس، مشخص کنید که فقط ردیف‌هایی که آن شرط را برآورده می‌کنند، در ساختار B-Tree ایندکس قرار بگیرند.

این کار باعث می‌شود که ایندکس شما بسیار **کوچکتر و کارآمدتر** شود و از شلوغ شدن آن با داده‌های غیرضروری و غیرجالب جلوگیری می‌کند.

---

#### **۲. ایجاد و استفاده از یک ایندکس جزئی**

ایجاد یک ایندکس جزئی بسیار ساده است. برای مثال، اگر بخواهیم یک ایندکس روی ستون `email` فقط برای کاربران حرفه‌ای (`is_pro = true`) ایجاد کنیم، به این صورت عمل می‌کنیم:

```postgresql
CREATE INDEX email_pro_users ON users (email) WHERE is_pro = true;
```

**نکته حیاتی برای استفاده:**
برای اینکه PostgreSQL بتواند از این ایندکس جزئی استفاده کند، **باید شرط (`predicate`) ایندکس دقیقاً در کوئری شما نیز وجود داشته باشد**.

- **کوئری اشتباه:** `'...' = WHERE email` (ایندکس استفاده نمی‌شود، زیرا PostgreSQL نمی‌داند که این ایمیل متعلق به یک کاربر حرفه‌ای است یا نه).
- **کوئری صحیح:** `WHERE email = '...' AND is_pro = true` (ایندکس استفاده می‌شود، زیرا شرط `is_pro = true` با `predicate` ایندکس مطابقت دارد).

---

#### **۳. مزایای ایندکس‌های جزئی**

- **افزایش کارایی `SELECT`:** با کوچک نگه داشتن ایندکس و حذف نویز، جستجوها سریع‌تر انجام می‌شوند.
- **افزایش کارایی `INSERT`, `UPDATE`, `DELETE`:** از آنجایی که ایندکس بسیار کوچکتر است، هزینه نگهداری (maintenance) آن نیز به شدت کاهش می‌یابد. دیگر نیازی نیست با هر تغییر، یک B-Tree عظیم با مقادیری که به آن‌ها اهمیت نمی‌دهید، به‌روز شود.

---

#### **۴. کاربرد قدرتمند: ایندکس منحصر به فرد جزئی (Partial Unique Index)**

یکی از قدرتمندترین کاربردهای ایندکس جزئی، ایجاد **محدودیت `UNIQUE` روی بخشی از جدول** است.

**سناریوی حذف نرم (Soft Deletes):**
تصور کنید در سیستم شما، کاربران به جای حذف کامل، به صورت نرم حذف می‌شوند (یعنی ستون `deleted_at` آن‌ها پر می‌شود). شما می‌خواهید که هر کاربر فعال (`deleted_at IS NULL`) ایمیل منحصر به فردی داشته باشد، اما اگر یک حساب کاربری حذف شد، آن ایمیل دوباره برای ثبت‌نام آزاد شود.

ایجاد یک محدودیت `UNIQUE` معمولی روی ستون `email` این اجازه را به شما نمی‌دهد. اما با یک ایندکس منحصر به فرد جزئی، این کار به راحتی ممکن است:

```postgresql
CREATE UNIQUE INDEX unique_active_email ON users (email) WHERE deleted_at IS NULL;
```

این ایندکس تضمین می‌کند که در میان تمام کاربران **فعال**، هیچ دو نفری ایمیل یکسان نداشته باشند، اما وجود چندین حساب کاربری حذف شده با ایمیل یکسان را مجاز می‌داند. این یک ابزار فوق‌العاده قدرتمند برای پیاده‌سازی منطق‌های پیچیده کسب‌وکار مستقیماً در سطح پایگاه داده است.

---

#### **۵. جمع‌بندی**

ایندکس‌های جزئی ابزاری بسیار کارآمد برای بهینه‌سازی عملکرد در جداولی با توزیع داده چوله هستند. آن‌ها به شما اجازه می‌دهند تا ایندکس‌هایی کوچکتر و سریع‌تر بسازید. ایندکس‌های منحصر به فرد جزئی نیز ابزاری قدرتمند برای اعمال قوانین پیچیده یکپارچگی داده هستند. کلید استفاده موفق از آن‌ها این است که به یاد داشته باشید **شرط ایندکس باید در کوئری شما تکرار شود** و برای طراحی آن‌ها باید درک خوبی از منطق کسب‌وکار خود داشته باشید.
