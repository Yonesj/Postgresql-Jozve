### **جلسه ۵۹: گره‌های اسکن (Scan Nodes)**

در این جلسه، به بررسی سه نوع گره اسکن اصلی که در طرح‌های اجرایی با آن‌ها مواجه می‌شوید، می‌پردازیم: پیمایش ترتیبی، پیمایش ایندکس بیت‌مپ، و پیمایش ایندکس.

---

#### **۱. پیمایش ترتیبی (Sequential Scan)**

این گره که دشمن قدیمی ماست، به این معناست که برنامه‌ریز کوئری (`query planner`) تصمیم گرفته است که باید بخش بزرگی (یا تمام) جدول را بخواند. در این حالت، بهینه‌ترین کار، خواندن جدول به **ترتیب فیزیکی روی دیسک (physical disk order)** است.

به یاد بیاورید که جدول در PostgreSQL به صورت مجموعه‌ای از صفحات (`pages`) ذخیره شده است. یک پیمایش ترتیبی، این صفحات را از ابتدا تا انتها به ترتیب می‌خواند. این کار از نظر عملیات ورودی/خروجی (`I/O`) بسیار سریع است، زیرا از پرش‌های تصادفی روی دیسک جلوگیری می‌کند. این روش زمانی انتخاب می‌شود که پایگاه داده تشخیص دهد مراجعه به ایندکس و سپس پرش به نقاط مختلف جدول، پرهزینه‌تر از خواندن یکجای کل جدول است.

---

#### **۲. پیمایش ایندکس بیت‌مپ (Bitmap Index Scan)**

این نوع پیمایش، حالتی میانی بین پیمایش کامل جدول و پیمایش مستقیم ایندکس است. این روش زمانی انتخاب می‌شود که پایگاه داده تشخیص می‌دهد نیازی به خواندن کل جدول نیست، اما تعداد ردیف‌هایی که باید از جدول خوانده شوند، به اندازه‌ای زیاد است که پرش‌های تصادفی (`random I/O`) می‌تواند پرهزینه باشد.

<div class='centered-div'>
  <img src="../../assets/images/understanding_query_plans/59_1.png">
</div>

فرآیند کار به صورت دو مرحله‌ای و با همکاری دو گره انجام می‌شود:

1.  **گره `Bitmap Index Scan`:** این گره ابتدا به سراغ ایندکس می‌رود و تمام ردیف‌هایی را که با شرط کوئری مطابقت دارند، پیدا می‌کند. سپس، به جای واکشی مستقیم ردیف‌ها، یک **bitmap** از آدرس فیزیکی (CTID) این ردیف‌ها ایجاد می‌کند.
2.  **گره `Bitmap Heap Scan`:** این گره bitmap را از گره قبلی دریافت کرده، آدرس‌ها را بر اساس **ترتیب فیزیکی** مرتب می‌کند و سپس با یک بار پیمایش در جدول (heap)، تمام ردیف‌های مورد نیاز را به ترتیب فیزیکی می‌خواند.

این همکاری هوشمندانه، مزایای هر دو روش را ترکیب می‌کند: سرعت پیدا کردن آدرس‌ها از طریق ایندکس، و کارایی خواندن ترتیبی داده‌ها از روی دیسک.

**نکته در مورد `Recheck Condition`:**
گاهی اوقات در گره `Bitmap Heap Scan`، یک ویژگی به نام `Recheck Condition` را می‌بینید. این به این معناست که پایگاه داده پس از واکشی ردیف از جدول، شرط را **دوباره** بررسی می‌کند. این اتفاق زمانی می‌افتد که نقشه بیتی تولید شده توسط ایندکس، به دلایلی (مانند زیاد بودن نتایج یا نوع خاص ایندکس) دقت کامل را نداشته و به جای آدرس دقیق ردیف‌ها، فقط شماره صفحه را مشخص کرده باشد.

---

#### **۳. پیمایش ایندکس (Index Scan)**

این بهترین و سریع‌ترین نوع گره اسکن برای واکشی داده از جدول است. این روش زمانی انتخاب می‌شود که PostgreSQL تخمین می‌زند تعداد ردیف‌هایی که باید بازگردانده شوند، **بسیار کم** است.

<div class='centered-div'>
  <img src="../../assets/images/understanding_query_plans/59_2.png">
</div>

در این حالت، فرآیند ایجاد نقشه بیتی و مرتب‌سازی وجود ندارد. گره `Index Scan` هر دو کار را با هم انجام می‌دهد:

1.  ایندکس را پیمایش (traverse) کرده و آدرس فیزیکی (CTID) ردیف‌های مورد نظر را پیدا می‌کند.
2.  بلافاصله و به صورت مستقیم (با پذیرفتن هزینه پرش تصادفی یا `random I/O`) به سراغ آن آدرس‌ها در جدول (heap) رفته و ردیف‌ها را واکشی می‌کند.

از آنجایی که تعداد ردیف‌ها کم است، هزینه پرش‌های تصادفی ناچیز بوده و این روش به سریع‌ترین حالت ممکن تبدیل می‌شود.

---

#### **۴. یک پله بالاتر: Index Only Scan**

به یاد داشته باشید که یک حالت حتی بهتر از `Index Scan` نیز وجود دارد و آن، **`Index Only Scan`** است. این حالت زمانی رخ می‌دهد که شما از یک **ایندکس پوششی (covering index)** استفاده می‌کنید و تمام اطلاعات مورد نیاز کوئری (هم در `WHERE` و هم در `SELECT`) در خود ایندکس وجود دارد. در این حالت، پایگاه داده **هرگز به جدول اصلی (heap) مراجعه نمی‌کند** و پاسخ را مستقیماً از ایندکس برمی‌گرداند.

---

#### **۵. جمع‌بندی: چگونه PostgreSQL تصمیم می‌گیرد؟**

انتخاب بین این گره‌های اسکن، عمدتاً به **تعداد ردیف‌هایی** که PostgreSQL تخمین می‌زند باید به گره والد خود بازگرداند، بستگی دارد:

- **تعداد ردیف‌های بسیار زیاد:** `Sequential Scan` (پیمایش کل جدول سریع‌تر است).
- **تعداد ردیف‌های متوسط:** `Bitmap Index Scan` (ایجاد نقشه و خواندن ترتیبی به صرفه است).
- **تعداد ردیف‌های بسیار کم:** `Index Scan` (پرش مستقیم به ردیف‌ها سریع‌تر است).

درک این سه نوع گره اسکن، به شما کمک می‌کند تا طرح‌های اجرایی را بهتر تحلیل کرده و دلیل تصمیمات برنامه‌ریز کوئری را درک کنید.
