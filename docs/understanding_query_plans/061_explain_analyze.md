### **جلسه ۶۱: دستور `EXPLAIN ANALYZE`**

تمام نتایجی که تا به حال از `EXPLAIN` دریافت کرده‌ایم، **تخمین (estimates)** بوده‌اند. این تخمین‌ها معمولاً خوب هستند، اما دقیق نیستند. اگر به دنبال گزارش **واقعی** از نحوه اجرای یک کوئری هستید، باید از `EXPLAIN ANALYZE` استفاده کنید.

---

#### **۱. هشدار بسیار مهم: `EXPLAIN ANALYZE` کوئری را اجرا می‌کند!**

قبل از هر چیز، یک نکته حیاتی وجود دارد: `EXPLAIN ANALYZE` کوئری شما را **واقعاً اجرا می‌کند**.

این یعنی اگر کوئری شما یک `UPDATE`، `DELETE` یا `INSERT` باشد، آن عملیات **انجام خواهد شد**. اگرچه نتایج `SELECT` به شما بازگردانده نمی‌شوند، اما هرگونه تغییر در داده‌ها اعمال خواهد شد. بنابراین، در استفاده از این دستور، به خصوص در محیط‌های تولید (production)، باید **بسیار محتاط** باشید.

---

#### **۲. اطلاعات جدید در خروجی `EXPLAIN ANALYZE`**

با افزودن کلمه کلیدی `ANALYZE`، اطلاعات بسیار بیشتری در خروجی طرح اجرایی ظاهر می‌شود.

<div class='centered-div'>
  <img src="../../assets/images/understanding_query_plans/61.png">
</div>

**زمان برنامه‌ریزی و زمان اجرا (`Planning Time` / `Execution Time`):** در انتهای خروجی، دو معیار جدید نمایش داده می‌شود. `Planning Time` مدت زمانی است که PostgreSQL صرف پیدا کردن بهترین طرح اجرایی کرده است و `Execution Time` مدت زمان واقعی اجرای آن طرح است.

**اطلاعات واقعی در هر گره:** برای هر گره، علاوه بر اطلاعات تخمینی، یک مجموعه اطلاعات جدید در داخل یک پرانتز اضافی نمایش داده می‌شود که شامل موارد زیر است:

- `actual time` : زمان واقعی شروع و پایان اجرای آن گره (به میلی‌ثانیه).
- `rows` : تعداد ردیف‌هایی که آن گره **واقعاً** تولید کرده است.
- `loops` : تعداد دفعاتی که آن گره اجرا شده است.

---

#### **۳. مقایسه مقادیر تخمینی و واقعی**

با داشتن مقادیر واقعی، اکنون می‌توانید آن‌ها را با مقادیر تخمینی مقایسه کنید. این مقایسه به شما کمک می‌کند تا بفهمید که آیا آمارهای (statistics) پایگاه داده شما به‌روز و دقیق هستند یا خیر. اگر تفاوت زیادی بین `rows` تخمینی و `rows` واقعی وجود داشته باشد، ممکن است نیاز به اجرای `ANALYZE` روی جدول خود داشته باشید.

---

#### **۴. تفاوت واحدها: `cost` در مقابل `actual time`**

به یاد داشته باشید که `cost` (هزینه تخمینی) و `actual time` (زمان واقعی) دو واحد کاملاً متفاوت هستند. `cost` یک واحد قراردادی و نسبی در PostgreSQL است، در حالی که `actual time` به **میلی‌ثانیه (milliseconds)** است. این دو عدد قرار نیست با هم برابر باشند.

اگر نمایش `cost` در خروجی `EXPLAIN ANALYZE` شما را گیج می‌کند، می‌توانید با استفاده از گزینه `COSTS OFF` آن را غیرفعال کنید:

```postgresql
EXPLAIN (ANALYZE, COSTS OFF) SELECT ...
```

---

#### **۵. درک پارامتر `loops`**

پارامتر `loops` نشان می‌دهد که یک گره چند بار اجرا شده است. این موضوع به خصوص در `JOIN`های تودرتو اهمیت پیدا می‌کند، جایی که یک گره داخلی ممکن است به ازای هر ردیف از گره خارجی، یک بار اجرا شود.

مقادیر زمانی و هزینه‌ای که برای چنین گره‌هایی نمایش داده می‌شود، معمولاً **میانگین (average)** به ازای هر بار اجرا است. بنابراین، اگر زمان اجرای یک گره کم باشد اما میلیون‌ها بار تکرار شده باشد، آن گره می‌تواند یکی از نقاط اصلی کندی کوئری شما باشد.

---

#### **۶. جمع‌بندی**

`EXPLAIN ANALYZE` یک ابزار فوق‌العاده مفید برای تشخیص مشکلات عملکردی است، به خصوص زمانی که `EXPLAIN` به تنهایی اطلاعات کافی را در اختیار شما قرار نمی‌دهد. اما به دلیل اینکه این دستور کوئری را واقعاً اجرا می‌کند، باید با احتیاط فراوان از آن استفاده کنید.
