### **جلسه ۷۱: ترکیب کوئری‌ها (Combining Queries)**

در این جلسه، به جای قرار دادن نتایج در کنار یکدیگر (کاری که با `JOIN` انجام دادیم)، یاد می‌گیریم چگونه نتایج دو یا چند کوئری مجزا را به صورت **عمودی و روی هم** قرار دهیم. برای این کار، از اپراتورهای `UNION` `INTERSECT` و `EXCEPT` استفاده خواهیم کرد.

---

#### **۱. پیش‌نیازهای ترکیب کوئری‌ها**

برای اینکه بتوانید نتایج دو کوئری را به صورت عمودی با هم ترکیب کنید، یک پیش‌نیاز اساسی وجود دارد:

!!! tip "نکته"
    هر دو کوئری باید **تعداد ستون‌های یکسان** با **انواع داده متناظر و یکسان** داشته باشند.

---

#### **۲. اپراتور `UNION`: اجتماع نتایج**

اپراتور `UNION` نتایج دو کوئری را گرفته و آن‌ها را در یک مجموعه نتیجه واحد با هم ترکیب می‌کند (مانند عملیات اجتماع در تئوری مجموعه‌ها).

- **رفتار پیش‌فرض (حذف تکراری‌ها):** به صورت پیش‌فرض، `UNION` ردیف‌های **تکراری** را از نتیجه نهایی **حذف می‌کند**. این فرآیند حذف تکراری (deduplication) می‌تواند بسیار پرهزینه باشد، زیرا PostgreSQL باید هر ردیف را با تمام ردیف‌های دیگر مقایسه کند.

- **`UNION ALL` (حفظ تکراری‌ها):** اگر می‌دانید که نتایج شما تکراری ندارند، یا اگر می‌خواهید ردیف‌های تکراری را حفظ کنید، باید از `UNION ALL` استفاده کنید. این نسخه به مراتب **سریع‌تر و بهینه‌تر** است، زیرا فرآیند پرهزینه مقایسه را انجام نمی‌دهد.

**مثال کاربردی:**
تصور کنید کاربران حذف شده را به یک جدول آرشیو (`users_archive`) منتقل می‌کنید تا جدول اصلی (`users`) کوچک و سریع باقی بماند. اگر بخواهید در هر دو جدول به صورت همزمان جستجو کنید، `UNION` یک راه‌حل عالی است. شما می‌توانید با اجرای کوئری جستجو روی هر دو جدول و سپس `UNION` کردن نتایج، یک جستجوی جامع انجام دهید.

```postgresql
(SELECT TRUE AS active, * FROM users WHERE email = 'jamshidiyounes92@gmail.com')
UNION ALL
(SELECT FALSE AS active, * FROM users_archive WHERE email = 'jamshidiyounes92@gmail.com');
```

---

#### **۳. اپراتور `INTERSECT`: اشتراک نتایج**

اپراتور `INTERSECT` نتایج دو کوئری را گرفته و فقط ردیف‌هایی را برمی‌گرداند که **در هر دو مجموعه نتیجه حضور دارند** (مانند عملیات اشتراک در تئوری مجموعه‌ها). برای مثال کوئری زیر نتیجه `3, 4, 5` را برمی‌گرداند.

```postgresql
SELECT generate_series(1, 5) INTERSECT SELECT generate_series(3, 7)
```

**`INTERSECT ALL`:** این نسخه نیز مانند `UNION ALL` از حذف تکراری‌ها صرف نظر کرده و سریع‌تر عمل می‌کند.

---

#### **۴. اپراتور `EXCEPT`: تفاضل نتایج**

اپراتور `EXCEPT` نتایج کوئری اول را گرفته و ردیف‌هایی را که در کوئری دوم نیز وجود دارند، از آن **حذف می‌کند** (مانند عملیات تفاضل در تئوری مجموعه‌ها). برای مثال کوئری زیر نتیجه `1, 2` را برمی‌گرداند.

```postgresql
SELECT generate_series(1, 5) EXCEPT SELECT generate_series(3, 7)
```

**`EXCEPT ALL`:** این نسخه نیز برای جلوگیری از حذف تکراری‌ها و افزایش سرعت به کار می‌رود.

---

#### **۵. ترکیب چند اپراتور و اهمیت پرانتز**

شما می‌توانید چندین اپراتور `UNION`، `INTERSECT` و `EXCEPT` را با هم زنجیروار به کار ببرید. اما به دلیل اینکه ترتیب اجرای عملیات (order of operations) ممکن است پیچیده و گیج‌کننده شود، **به شدت توصیه می‌شود** که برای شفاف‌سازی و کنترل ترتیب اجرا، از **پرانتز** استفاده کنید.

---

#### **۶. جمع‌بندی و توصیه نهایی**

- `UNION`: نتایج دو کوئری را با هم ترکیب می‌کند.
- `INTERSECT`: اشتراک نتایج دو کوئری را پیدا می‌کند.
- `EXCEPT`: تفاضل نتایج دو کوئری را محاسبه می‌کند.

!!! note "توصیه مهم"
    همیشه به صورت آگاهانه در مورد حذف یا عدم حذف ردیف‌های تکراری تصمیم بگیرید. اگر به حذف تکراری‌ها نیازی ندارید یا مطمئن هستید که تکراری وجود ندارد، همیشه از نسخه `ALL` این اپراتورها (`UNION ALL`, `INTERSECT ALL`, `EXCEPT ALL`) استفاده کنید تا از مقایسه‌های پرهزینه جلوگیری کرده و عملکرد بهتری داشته باشید.
