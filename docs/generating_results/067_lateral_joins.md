### **جلسه ۶۷: اتصال جانبی (LATERAL JOIN)**

یک اتصال جانبی (`LATERAL JOIN`) یک نوع `JOIN` جدید نیست، بلکه یک **توصیف‌گر (qualifier)** است که می‌توان آن را به `JOIN`های موجود (مانند `LEFT JOIN`، `INNER JOIN` یا `CROSS JOIN`) اضافه کرد.

---

#### **۱. `LATERAL` چه کاری انجام می‌دهد؟**

کلمه کلیدی `LATERAL` به PostgreSQL می‌گوید:

**به ازای هر ردیف (`for every row`)** از جدول قبلی (جدول سمت چپ)، این زیرکوئری را یک بار اجرا کن.

این قابلیت به ما اجازه می‌دهد تا در داخل یک زیرکوئری، به ستون‌های ردیف فعلی از جدول بیرونی ارجاع دهیم، کاری که در یک زیرکوئری معمولی ممکن نیست. به این فرآیند اجرای زیرکوئری به ازای هر ردیف، "اتصال جانبی" می‌گویند.

---

#### **۲. کاربرد عملی: پیدا کردن "N سطر برتر به ازای هر گروه"**

یکی از کلاسیک‌ترین مسائل در SQL، پیدا کردن "N سطر برتر به ازای هر گروه" است. برای مثال، فرض کنید می‌خواهیم **آخرین بوکمارک (most recent bookmark)** را برای **هر کاربر** پیدا کنیم. `LATERAL JOIN` یک راه‌حل بسیار زیبا و خوانا برای این مسئله است.

```postgresql
SELECT users.id, users.first_name, most_recent_bookmark.url
FROM
	users LEFT JOIN LATERAL (
		SELECT * FROM bookmarks
		WHERE bookmarks.user_id = users.id
		ORDER BY id DESC
		LIMIT 1
	) AS most_recent_bookmark ON true;

```

برای این کار، ما جدول `users` را به نتیجه یک زیرکوئری `LEFT JOIN LATERAL` می‌کنیم. این زیرکوئری به صورت زیر تعریف می‌شود:

1.  از جدول `bookmarks` انتخاب می‌کند.
2.  شرط `WHERE` آن، `user_id` بوکمارک را با `users.id` (یعنی `id` کاربر فعلی از جدول بیرونی) مقایسه می‌کند.
3.  نتایج را بر اساس `id` به صورت نزولی مرتب کرده (`ORDER BY id DESC`) و فقط یک نتیجه اول را با `LIMIT 1` برمی‌گرداند.

---

#### **۳. نکات مهم در سینتکس `LATERAL JOIN`**

- **کلمه کلیدی `LATERAL`:** اگر در زیرکوئری خود به جدول بیرونی ارجاع دهید، PostgreSQL شما را مجبور می‌کند که حتماً از کلمه کلیدی `LATERAL` استفاده کنید. در غیر این صورت، با خطا مواجه خواهید شد.
- **شرط `ON true`:** از آنجایی که تمام منطق فیلتر کردن و اتصال در داخل خود زیرکوئری (در بخش `WHERE`) انجام شده است، دیگر نیازی به یک شرط `ON` پیچیده نداریم و می‌توانیم به سادگی از `ON true` استفاده کنیم.

---

#### **۴. ملاحظات عملکردی (Performance Considerations)**

از آنجایی که زیرکوئری به ازای هر ردیف از جدول بیرونی یک بار اجرا می‌شود، `LATERAL JOIN` می‌تواند به طور بالقوه **بسیار پرهزینه** باشد. اگر جدول بیرونی شما میلیون‌ها ردیف داشته باشد، این زیرکوئری نیز میلیون‌ها بار اجرا خواهد شد.

بنابراین، در استفاده از `LATERAL JOIN` باید محتاط بود و عملکرد آن را به دقت تست کرد. با این حال، برای بسیاری از مسائل، این روش دقیقاً راه‌حل مناسب است و نباید از استفاده از آن ترسید.

---

#### **۵. جمع‌بندی**

`LATERAL JOIN` یک ابزار بسیار قدرتمند برای حل مسائلی است که در آن‌ها نیاز به اجرای یک کوئری وابسته به ازای هر ردیف از یک مجموعه نتایج دیگر دارید. این روش به خصوص برای مسائل "N سطر برتر به ازای هر گروه" بسیار کارآمد است. با این حال، همیشه باید به پیامدهای عملکردی آن توجه داشته و آن را تست کنید. در جلسات آینده (در بخش `CTE`)، به روش‌های دیگری برای حل همین مسئله نیز خواهیم پرداخت.
